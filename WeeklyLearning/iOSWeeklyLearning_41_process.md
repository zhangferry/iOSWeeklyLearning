1# iOS æ‘¸é±¼å‘¨æŠ¥ ç¬¬å››åä¸€æœŸ

![](https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/moyu_weekly_cover.jpeg)

### æœ¬æœŸæ¦‚è¦

> * è¯é¢˜ï¼š
> * Tipsï¼šåœ¨ Objective-C ä¸­æ ‡è®°æ„é€ å™¨ä¸ºæŒ‡å®šæ„é€ å™¨ã€‚
> * é¢è¯•æ¨¡å—ï¼š
> * ä¼˜ç§€åšå®¢ï¼š
> * å­¦ä¹ èµ„æ–™ï¼š
> * å¼€å‘å·¥å…·ï¼š

## æœ¬æœŸè¯é¢˜

### In-App Events æ•°æ®åˆ†æå¯ä»¥æŸ¥çœ‹äº†

In-App Events çš„å±•ç¤ºæ•ˆæœæ•°æ®å¯ä»¥åœ¨ App Store Connect ä¸­çš„åº”ç”¨åˆ†ææŸ¥çœ‹äº†ã€‚åº”ç”¨åˆ†æè¿˜åŒ…æ‹¬äº‹ä»¶çš„é¡µé¢å±•ç¤ºï¼Œæé†’å’Œé€šçŸ¥æ•°æ®ï¼Œä»¥åŠç”±ä½ çš„ In-App Events è§¦å‘çš„ä¸‹è½½å’Œé‡æ–°ä¸‹è½½çš„æ•°é‡ã€‚æ¯ä¸ªæŒ‡æ ‡éƒ½å¯ä»¥æ ¹æ®åŒºåŸŸã€èµ„æºç±»å‹ã€è®¾å¤‡ç­‰è¿›è¡ŒæŸ¥çœ‹ï¼Œè¿™æ ·ä½ å°±å¯ä»¥äº†è§£ In-App Events æ˜¯å¦‚ä½•å½±å“åº”ç”¨çš„å‘å±•å’ŒæˆåŠŸçš„äº†ã€‚

[Analytics now available for in-app events](https://developer.apple.com/news/?id=pa0x2dzk "Analytics now available for in-app events")

### çº¿ä¸Šç›´æ’­æ²™é¾™ - æŠ–éŸ³ iOS åŸºç¡€æŠ€æœ¯å¤§æ­ç§˜

**å†…å®¹ä»‹ç»**ï¼šå¦‚ä½•ä¿è¯æŠ–éŸ³ App çš„ç¨³å®šæ€§ï¼Ÿå¦‚ä½•ç»™ç”¨æˆ·å¸¦æ¥å¦‚ä¸èˆ¬æŸ”æ»‘çš„æµç•…ä½“éªŒï¼Ÿå¦‚ä½•åœ¨ç”¨æˆ·å¼±æ„ŸçŸ¥ç”šè‡³æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹ï¼Œæ¨è¿›æŠ–éŸ³ App çš„æ¶æ„æ¼”è¿›ï¼Ÿå¦‚ä½•åˆ©ç”¨å®¹å™¨ç­‰æŠ€æœ¯æ¨è¿›è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Ÿå­—èŠ‚è‡ªç ”çš„ iOS æ„å»ºç³»ç»Ÿ JOJO åˆæ˜¯å¦‚ä½•å®ç°è¶…çº§ App æ„å»ºæ•ˆèƒ½æå‡ 40% çš„ï¼Ÿæœ¬æœŸå­—èŠ‚è·³åŠ¨æŠ€æœ¯æ²™é¾™å°†ä»¥ã€ŠæŠ–éŸ³ iOS åŸºç¡€æŠ€æœ¯å¤§æ­ç§˜ã€‹ä¸ºä¸»é¢˜ï¼Œä¸ºä½ å…¨é¢æ­å¼€æŠ–éŸ³ iOS åŸºç¡€æŠ€æœ¯èƒŒåçš„æŠ€æœ¯èƒ½åŠ›ï¼

**æ²™é¾™æ—¶é—´**ï¼š2022 å¹´ 1 æœˆ 22 æ—¥ 14:00-17:25

**æŠ¥ååœ°å€**ï¼š[ç™¾æ ¼æ´»åŠ¨](https://www.bagevent.com/event/sales/i843tlja9we9xhc7ujim43jiaxn15sdl?code=0617daGa1vyXqC0aiPGa1cZLRM07daGm&state=STATE "çº¿ä¸Šç›´æ’­æ²™é¾™-æŠ–éŸ³iOSåŸºç¡€æŠ€æœ¯å¤§æ­ç§˜")

## å¼€å‘ Tips

æ•´ç†ç¼–è¾‘ï¼š[å¸ˆå¤§å°æµ·è…¾](https://juejin.cn/user/782508012091645/posts)

### åœ¨ Objective-C ä¸­æ ‡è®°æ„é€ å™¨ä¸ºæŒ‡å®šæ„é€ å™¨

è¿™æ˜¯ä¸€ä¸ªå¼€å‘ tipï¼Œä¸€ä¸ªç¼–ç è§„èŒƒï¼Œä¹Ÿæ˜¯å¿«æ‰‹çš„ä¸€é“é¢è¯•çœŸé¢˜ã€‚

æŒ‡å®šæ„é€ å™¨æ¨¡å¼æœ‰åŠ©äºç¡®ä¿ç»§æ‰¿çš„æ„é€ å™¨æ­£ç¡®åœ°åˆå§‹åŒ–æ‰€æœ‰å®ä¾‹å˜é‡ã€‚æŒ‡å®šæ„é€ å™¨é€šå¸¸ä¸ºç±»ä¸­æ¥æ”¶å…¨éƒ¨åˆå§‹åŒ–å‚æ•°çš„å…¨èƒ½æ„é€ å™¨ï¼Œæ˜¯ç±»ä¸­æœ€é‡è¦çš„æ„é€ å™¨ï¼›ä¾¿åˆ©æ„é€ å™¨é€šå¸¸ä¸ºæ¥æ”¶éƒ¨åˆ†åˆå§‹åŒ–å‚æ•°çš„æ„é€ å™¨ï¼Œå®ƒä»¬è°ƒç”¨å½“å‰ç±»çš„å…¶å®ƒæ„é€ å™¨ï¼Œå¹¶ä¸ºä¸€äº›å‚æ•°èµ‹é»˜è®¤å€¼ã€‚ä¾¿åˆ©æ„é€ å™¨æ˜¯ç±»ä¸­æ¯”è¾ƒæ¬¡è¦çš„ã€è¾…åŠ©å‹çš„æ„é€ å™¨ã€‚

Objective-C ç±»çš„æŒ‡å®šæ„é€ å™¨æ¨¡å¼å’Œ Swift çš„ç•¥æœ‰ä¸åŒã€‚åœ¨ Objective-C ä¸­ï¼Œä¸ºäº†æ˜ç¡®åŒºåˆ†æŒ‡å®šæ„é€ å™¨å’Œä¾¿åˆ©æ„é€ å™¨ï¼Œå¯ä»¥ä½¿ç”¨å® `NS_DESIGNATED_INITIALIZER` æ ‡è®°æ„é€ å™¨ä¸ºæŒ‡å®šæ„é€ å™¨ï¼Œå…¶å®ƒæœªæ·»åŠ è¯¥å®çš„æ„é€ å™¨éƒ½æˆä¸ºäº†ä¾¿åˆ©æ„é€ å™¨ã€‚

```objectivec
- (instancetype)init NS_DESIGNATED_INITIALIZER;
```

ä½¿ç”¨è¿™ä¸ªå®ä¼šå¼•å…¥ä¸€äº›è§„åˆ™ï¼š

1. æŒ‡å®šæ„é€ å™¨çš„å®ç°åªèƒ½ä¸”å¿…é¡»`å‘ä¸Šä»£ç†`åˆ°çˆ¶ç±»çš„ä¸€ä¸ªæŒ‡å®šæ„é€ å™¨ï¼ˆwith `[super init...]`ï¼‰ï¼›
2. ä¾¿åˆ©æ„é€ å™¨çš„å®ç°åªèƒ½ä¸”å¿…é¡»`æ¨ªå‘ä»£ç†`åˆ°å½“å‰ç±»çš„å¦ä¸€ä¸ªæ„é€ å™¨ï¼ˆwith `[self init...]`ï¼‰ï¼Œæœ€ç»ˆéœ€è¦åœ¨å½“å‰ç±»çš„æŒ‡å®šæ„é€ å™¨å¤„ç»ˆæ­¢é“¾ï¼›
3. å¦‚æœä¸€ä¸ªç±»æä¾›äº†ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šæ„é€ å™¨ï¼Œå®ƒå¿…é¡»è¦†å†™å…¶çˆ¶ç±»çš„æ‰€æœ‰æŒ‡å®šæ„é€ å™¨ä½œä¸ºï¼ˆé€€åŒ–ä¸ºï¼‰è¯¥ç±»çš„ä¾¿åˆ©æ„é€ å™¨ï¼Œå¹¶è®©å…¶æ»¡è¶³æ¡ä»¶ 2ã€‚è¿™æ ·æ‰èƒ½ä¿è¯å­ç±»æ–°å¢çš„å®ä¾‹å˜é‡å¾—åˆ°æ­£ç¡®çš„åˆå§‹åŒ–ã€‚

å¦‚æœè¿åäº†ä»¥ä¸Šä»»ä½•è§„åˆ™ï¼Œå°†ä¼šå¾—åˆ°ç¼–è¯‘å™¨çš„è­¦å‘Šã€‚

![](https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/20220112232618.png)

ç®€å•æ¥è¯´ï¼ŒæŒ‡å®šæ„é€ å™¨å¿…é¡»æ€»æ˜¯`å‘ä¸Šä»£ç†`ï¼Œä¾¿åˆ©æ„é€ å™¨å¿…é¡»æ€»æ˜¯`æ¨ªå‘ä»£ç†`ã€‚

![](https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/20220112232822.png)

å¦å¤–ï¼Œåœ¨ Objective-C ä¸­ï¼Œä½ è¿˜å¿…é¡»è¦†å†™çˆ¶ç±»çš„æ‰€æœ‰æŒ‡å®šæ„é€ å™¨é€€åŒ–ä¸ºå­ç±»çš„ä¾¿åˆ©æ„é€ å™¨ï¼Œå¹¶ä¸”è¦éµå¾ªä¾¿åˆ©æ„é€ å™¨çš„å®ç°è§„åˆ™ï¼›è€Œ Swift åˆ™ä¸ç”¨ï¼Œå› ä¸º Swift ä¸­çš„å­ç±»é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šç»§æ‰¿çˆ¶ç±»çš„æ„é€ å™¨ï¼Œä»…ä¼šåœ¨å®‰å…¨å’Œé€‚å½“çš„æŸäº›æƒ…å†µä¸‹è¢«ç»§æ‰¿ã€‚Swift çš„è¿™ç§æœºåˆ¶å¯ä»¥é˜²æ­¢ä¸€ä¸ªçˆ¶ç±»çš„ç®€å•æ„é€ å™¨è¢«ä¸€ä¸ªæ›´ç²¾ç»†çš„å­ç±»ç»§æ‰¿ï¼Œè€Œåœ¨ç”¨æ¥åˆ›å»ºå­ç±»æ—¶çš„æ–°å®ä¾‹æ—¶æ²¡æœ‰å®Œå…¨æˆ–é”™è¯¯è¢«åˆå§‹åŒ–ã€‚

åœ¨ Objective-C ä¸­ï¼Œä½¿ç”¨å® `NS_DESIGNATED_INITIALIZER` æ ‡è®°æ„é€ å™¨ä¸ºæŒ‡å®šæ„é€ å™¨ï¼Œå¯ä»¥å……åˆ†å‘æŒ¥ç¼–è¯‘å™¨çš„ç‰¹æ€§å¸®æˆ‘ä»¬æ‰¾å‡ºåˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨çš„æ¼æ´ï¼ˆé€šè¿‡è­¦å‘Šï¼‰ï¼Œæœ‰åŠ©äºç¡®ä¿ç»§æ‰¿çš„æ„é€ å™¨æ­£ç¡®åœ°åˆå§‹åŒ–æ‰€æœ‰å®ä¾‹å˜é‡ï¼Œè®©æ„é€ è¿‡ç¨‹æ›´å®Œæ•´ï¼Œå¢å¼ºä»£ç çš„å¥å£®æ€§ã€‚

ç¤ºä¾‹ä»£ç ï¼š

```objective-c
@interface MyClass : NSObject
- (instancetype)initWithTitle:(nullable NSString *)title subtitle:(nullable NSString *)subtitle NS_DESIGNATED_INITIALIZER;
- (instancetype)initWithTitle:(nullable NSString *)title;
- (instancetype)init;
@end
  
@implementation MyClass
  
- (instancetype)initWithTitle:(nullable NSString *)title subtitle:(nullable NSString *)subtitle {
    self = [super init]; // [è§„åˆ™1] æŒ‡å®šæ„é€ å™¨åªèƒ½å‘ä¸Šä»£ç†åˆ°çˆ¶ç±»æŒ‡å®šæ„é€ å™¨ï¼Œå¦åˆ™ä¼šå¾—åˆ°ç¼–è¯‘å™¨è­¦å‘Šï¼šDesignated initializer should only invoke a designated initializer on 'super'
    if (self) {
        _title = [title copy];
        _subtitle = [subtitle copy];
    }
    return self;
}

- (instancetype)initWithTitle:(nullable NSString *)title {
/* 
    return [super init]; 
    [è§„åˆ™2] å½“è¯¥ç±»è®¾å®šäº†æŒ‡å®šæ„é€ å™¨ä¹Ÿå°±æ˜¯ä½¿ç”¨äº† NS_DESIGNATED_INITIALIZER åï¼Œå…¶å®ƒéæŒ‡å®šæ„é€ å™¨éƒ½å˜æˆäº†ä¾¿åˆ©æ„é€ å™¨ã€‚
    ä¾¿åˆ©æ„é€ å™¨åªèƒ½æ¨ªå‘ä»£ç†åˆ°è¯¥ç±»çš„æŒ‡å®šæ„é€ å™¨ï¼Œæˆ–è€…é€šè¿‡æ¨ªå‘ä»£ç†åˆ°å…¶å®ƒä¾¿åˆ©æ„é€ å™¨æœ€åé—´æ¥ä»£ç†åˆ°è¯¥ç±»çš„æŒ‡å®šæ„é€ å™¨ã€‚
    è¿™é‡Œè°ƒç”¨ [super init] çš„è¯ä¼šå¾—åˆ°ç¼–è¯‘å™¨è­¦å‘Šï¼š
    	- Convenience initializer missing a 'self' call to another initializer
    	- Convenience initializer should not invoke an initializer on 'super'
 */
    return [self initWithTitle:title subtitle:nil];
}

// [è§„åˆ™3] å¦‚æœå­ç±»æä¾›äº†æŒ‡å®šæ„é€ å™¨ï¼Œé‚£ä¹ˆéœ€è¦é‡å†™æ‰€æœ‰çˆ¶ç±»çš„æŒ‡å®šæ„é€ å™¨ä¸ºå­ç±»çš„ä¾¿åˆ©æ„é€ å™¨ï¼Œä¿è¯å­ç±»æ–°å¢çš„å®ä¾‹å˜é‡èƒ½å¤Ÿè¢«æ­£ç¡®åˆå§‹åŒ–ï¼Œä»¥è®©æ„é€ è¿‡ç¨‹æ›´å®Œæ•´ã€‚
// è¿™é‡Œéœ€è¦é‡å†™ -initï¼Œå¦åˆ™ä¼šå¾—åˆ°ç¼–è¯‘å™¨è­¦å‘Šï¼šMethod override for the designated initializer of the superclass '-init' not found
- (instancetype)init {
    return [self initWithTitle:nil];
}

@end
```

## é¢è¯•è§£æ

æ•´ç†ç¼–è¾‘ï¼š[å¼ é£](https://juejin.cn/user/782508012091645/posts)

### å¦‚ä½•æ£€æµ‹å†…å­˜æ³„éœ²

æ£€æµ‹å†…å­˜æ³„éœ²æœ‰å¤šç§æ–¹æ¡ˆï¼Œå¤§ä½“å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼šå·¥å…·å’Œä»£ç ã€‚

#### å·¥å…·ç±»

å·¥å…·ç±»æ¯”è¾ƒå¤šï¼š

* Instruments é‡Œçš„ Leaks

* Memory Graph Debugger

* Schems é‡Œçš„ Memory Management

* XCTest ä¸­çš„ XCTMemoryMetric

å‰ä¸¤ç§æ–¹å¼æ¯”è¾ƒå¸¸è§ï¼Œåä¸¤ç§å†…å­˜æ³„éœ²è¿˜éœ€è¦å€ŸåŠ©äº Xcode å¯¼å‡ºçš„ memgraph æ–‡ä»¶ï¼Œç»“åˆ `leaks`ã€`malloc_history` ç­‰å‘½ä»¤è¡Œå·¥å…·è¿›è¡Œåˆ†æã€‚å·¥å…·ç±»æ£€æµ‹æ–¹æ¡ˆéƒ½æœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯æ¯”è¾ƒç¹çï¼Œå¼€å‘é˜¶æ®µå¾ˆå®¹æ˜“é—æ¼ï¼Œæ‰€ä»¥åŸºäºä»£ç çš„è‡ªåŠ¨åŒ–å†…å­˜æ³„éœ²æ£€æµ‹æ–¹æ¡ˆæ›´é€‚åˆä½¿ç”¨ã€‚

#### ä»£ç ç±»

ä»£ç ç±»æ£€æµ‹æ³„éœ²æ–¹å¼æœ‰ä¸‰ä¸ªå…¸å‹çš„åº“ã€‚

**MLeaksFinder**

åœ°å€ï¼šhttps://github.com/Tencent/MLeaksFinder

å®ƒçš„åŸºæœ¬åŸç†æ˜¯è¿™æ ·çš„ï¼Œå½“ä¸€ä¸ª ViewController è¢« pop æˆ– dismiss ä¹‹åï¼Œæˆ‘ä»¬è®¤ä¸ºè¯¥ ViewControllerï¼ŒåŒ…æ‹¬å®ƒä¸Šé¢çš„å­ ViewControllerï¼Œä»¥åŠå®ƒçš„ Viewï¼ŒView çš„ subView ç­‰ç­‰ï¼Œéƒ½å¾ˆå¿«ä¼šè¢«é‡Šæ”¾ï¼Œå¦‚æœæŸä¸ª View æˆ–è€… ViewController æ²¡é‡Šæ”¾ï¼Œæˆ‘ä»¬å°±è®¤ä¸ºè¯¥å¯¹è±¡æ³„æ¼äº†ã€‚

å®ƒæ˜¯åŸºäº Method Swizzled æ–¹å¼ï¼Œéœ€è¦ Hook ViewController çš„ `viewDidDisappear` ï¼Œ`viewWillAppear` ç­‰æ–¹æ³•ã€‚æ‰€ä»¥ä»…é€‚ç”¨äº Objective-C é¡¹ç›®ã€‚

**LifetimeTracker**

åœ°å€ï¼šhttps://github.com/krzysztofzablocki/LifetimeTracker

LifetimeTracker æ˜¯ä½¿ç”¨ Swift å®ç°çš„ï¼Œå¯ä»¥åŒæ—¶æ”¯æŒ OC å’Œ Swift é¡¹ç›®ã€‚å®ƒçš„åŸç†æ˜¯ç”¨ä¸€ä¸ªåè®®è¡¨è¾¾ç›‘å¬æ³„éœ²èƒ½åŠ›ï¼Œæˆ‘ä»¬æå‰è®¾ç½®ç›‘å¬å…¥å£å’Œå…è®¸å­˜åœ¨çš„å¯¹è±¡ä¸ªæ•°ã€‚å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªç±»ä¼¼å¼•ç”¨è®¡æ•°ä¸€æ ·çš„æ•°å€¼ï¼Œè¿›å…¥ç›‘å¬ä¼šè¿›è¡Œä¸€ä¸ª +1 æ“ä½œï¼Œè¿˜ä¼šç›‘å¬è¯¥å¯¹è±¡çš„ `deinit` æ–¹æ³•ï¼Œå¦‚æœè°ƒç”¨æ‰§è¡Œ `-1`ã€‚å¦‚æœè¯¥ã€Œå¼•ç”¨è®¡æ•°ã€å¤§äºæˆ‘ä»¬è®¾ç½®çš„æœ€å¤§å¯¹è±¡ä¸ªæ•°ï¼Œå°±è§¦å‘å¯è§†åŒ–çš„æ³„éœ²è­¦å‘Šã€‚

ç®€åŒ–ä¸€äº›æµç¨‹ä¹‹åçš„ä»£ç ï¼š

```swift
internal func track(_ instance: Any, configuration: LifetimeConfiguration, file: String = #file) {
    let instanceType = type(of: instance)
    let configuration = configuration
    configuration.instanceName = String(reflecting: instanceType)

    func update(_ configuration: LifetimeConfiguration, with countDelta: Int) {
        let groupName = configuration.groupName ?? Constants.Identifier.EntryGroup.none
        let group = self.trackedGroups[groupName] ?? EntriesGroup(name: groupName)
        group.updateEntry(configuration, with: countDelta)
        // æ£€æµ‹å½“å‰è®¡æ•°æ˜¯å¦å¤§äºæœ€å¤§å¼•ç”¨æ•°
        if let entry = group.entries[configuration.instanceName], entry.count > entry.maxCount {
            self.onLeakDetected?(entry, group)
        }
        self.trackedGroups[groupName] = group
    }
    // å¼€å§‹æ£€æµ‹ï¼Œè®¡æ•°+1
    update(configuration, with: +1)

    onDealloc(of: instance) {
        // æ‰§è¡Œdeinitï¼Œè®¡æ•°-1
        update(configuration, with: -1)
    }
}
```

**FBRetainCycleDetector**

åœ°å€ï¼šhttps://github.com/facebook/FBRetainCycleDetector

ä¸Šé¢ä¸¤ç§æ–¹æ¡ˆéƒ½æ˜¯ç²—ç•¥çš„æ£€æµ‹ï¼Œæ˜¯ ViewController æˆ–è€… View çº§åˆ«çš„ï¼Œè¦æƒ³çŸ¥é“æ›´å…·ä½“çš„ä¿¡æ¯ï¼Œåˆ°åº•å“ªé‡Œå¯¼è‡´çš„å¾ªç¯åº”ç”¨å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚è€Œ FBRetainCycleDetector å°±æ˜¯ç”¨äºè§£å†³è¿™ç±»é—®é¢˜ï¼Œå› ä¸ºéœ€è¦å€ŸåŠ© OC çš„åŠ¨æ€ç‰¹æ€§ï¼Œæ‰€ä»¥è¯¥åº“æ— æ³•åœ¨ Swift é¡¹ç›®ä¸­å‘æŒ¥ä½œç”¨ã€‚

å®ƒçš„å®ç°ç›¸å¯¹ä¸Šé¢ä¸¤ä¸ªæ–¹æ¡ˆæ›´å¤æ‚ä¸€äº›ï¼Œå¤§è‡´åŸç†æ˜¯åŸºäº`DFS`ç®—æ³•ï¼ŒæŠŠæ•´ä¸ªå¯¹è±¡ä¹‹é—´çš„å¼ºå¼•ç”¨å…³ç³»å½“åšå›¾è¿›è¡Œå¤„ç†ï¼ŒæŸ¥æ‰¾å…¶ä¸­çš„ç¯ï¼Œå°±æ‰¾åˆ°äº†å¾ªç¯å¼•ç”¨ã€‚

æ ¸å¿ƒæ˜¯å¯»æ‰¾å¯¹è±¡ä¹‹é—´çš„å¼ºå¼•ç”¨å…³ç³»ï¼Œåœ¨ OC è¯­è¨€ä¸­ï¼Œå¼ºå¼•ç”¨å…³ç³»ä¸»è¦å‘ç”Ÿåœ¨è¿™ä¸‰ç§åœºæ™¯é‡Œï¼Œé’ˆå¯¹è¿™ä¸‰ç§åœºæ™¯ä¹Ÿæœ‰ä¸åŒçš„å¤„ç†æ–¹æ¡ˆï¼š

**ç±»çš„æˆå‘˜å˜é‡**

é€šè¿‡`runtime`çš„`class_getIvarLayout`è·å–æè¿°è¯¥ç±»æˆå‘˜å˜é‡çš„å¸ƒå±€ä¿¡æ¯ï¼Œç„¶åé€šè¿‡`ivar_getOffset`éå†è·å–æˆå‘˜å˜é‡åœ¨ç±»ç»“æ„ä¸­çš„åç§»åœ°å€ï¼Œç„¶åè·å–å¼ºå¼•ç”¨å˜é‡çš„é›†åˆã€‚

**å…³è”å¯¹è±¡**

åˆ©ç”¨ fishhook hook `objc_setAssociatedObject` å’Œ `objc_removeAssociatedObjects` è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯¹é€šè¿‡`OBJC_ASSOCIATION_RETAIN`å’Œ`OBJC_ASSOCIATION_RETAIN_NONATOMIC`ç­–ç•¥è¿›è¡Œå…³è”çš„å¯¹è±¡è¿›è¡Œä¿å­˜ã€‚

**blockæŒæœ‰**

ç†è§£è¿™ä¸ªåŸç†è¿˜éœ€è¦å†å›é¡¾ä¸‹ block çš„å†…å­˜å¸ƒå±€ï¼ŒFBRetainCycleDetector å¯¹ block ç»“æ„ä½“è¿›è¡Œäº†ç­‰ä»·çš„å°è£…ï¼š

```c
struct BlockLiteral {
    void *isa;
    int flags;
    int reserved;
    void (*invoke)(void *, ...);
    struct BlockDescriptor *descriptor;
    // imported variables
};

struct BlockDescriptor {
  unsigned long int reserved;                // NULL
  unsigned long int size;
  // optional helper functions
  void (*copy_helper)(void *dst, void *src); // IFF (1<<25)
  void (*dispose_helper)(void *src);         // IFF (1<<25)
  const char *signature;                     // IFF (1<<30)
};
```

åœ¨ `BlockLiteral` ç»“æ„ä½“çš„ descriptor å­—æ®µä¹‹åçš„ä½ç½®ä¼šå­˜æ”¾ block æŒæœ‰çš„å¯¹è±¡ï¼Œä½†æ˜¯å¹¶éæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å¤„ç†å¼ºå¼•ç”¨å¯¹è±¡å³å¯ã€‚è€Œæ°æ° block çš„å¼•ç”¨å¯¹è±¡æ’åˆ—åŸºäºå¯»å€é•¿åº¦å¯¹é½ï¼Œè¾ƒå¤§åœ°å€æ”¾åœ¨å‰é¢ï¼Œä¸”å¼ºå¼•ç”¨å¯¹è±¡ä¼šæ’åœ¨å¼±å¼•ç”¨ä¹‹å‰ï¼Œæ‰€ä»¥ä» descriptor ä¹‹åçš„æˆå‘˜å˜é‡ï¼Œå¯ä»¥æŒ‰å›ºå®šçš„æŒ‡é’ˆé•¿åº¦ä¾æ¬¡å–å‡ºå¯¹è±¡ã€‚è¿™ä¹‹åçš„å¯¹è±¡ç”¨ `FBBlockStrongRelationDetector` å°è£…ï¼Œä½†è¿™æœ‰å¯èƒ½ä¼šå¤šå–å¯¹è±¡ï¼Œæ¯”å¦‚ weak ç±»å‹çš„å¼•ç”¨å…¶å®æ˜¯ä¸éœ€è¦æ•æ‰çš„ã€‚

è¯¥åº“çš„åšæ³•æ˜¯é‡å†™ `FBBlockStrongRelationDetector` å¯¹è±¡çš„ release æ–¹æ³•ï¼Œä»…è®¾ç½®æ ‡è®°ä½ï¼Œç„¶åå¤–éƒ¨è°ƒç”¨å®ƒçš„ dispose æ–¹æ³•ï¼Œè¿™æ ·å…¶å¼ºå¼•ç”¨å¯¹è±¡éƒ½ä¼šè°ƒç”¨ releaseï¼Œè¢«è°ƒç”¨è¿™éƒ¨åˆ†éƒ½æ˜¯å¼ºå¼•ç”¨å¯¹è±¡ã€‚

```objectivec
static NSIndexSet *_GetBlockStrongLayout(void *block) {
	...
	void (*dispose_helper)(void *src) = blockLiteral->descriptor->dispose_helper;
	const size_t ptrSize = sizeof(void *);	
	const size_t elements = (blockLiteral->descriptor->size + ptrSize - 1) / ptrSize;
	
	void *obj[elements];
	void *detectors[elements];
	
	for (size_t i = 0; i < elements; ++i) {
		FBBlockStrongRelationDetector *detector = [FBBlockStrongRelationDetector new];
		obj[i] = detectors[i] = detector;
	}
	
	@autoreleasepool {
		dispose_helper(obj);
	}
	...
}
```

å½“æ‹¿åˆ°ä»¥ä¸Šæ‰€æœ‰å¼ºå¼•ç”¨å…³ç³»æ—¶å°±å¯ä»¥åˆ©ç”¨ DFS æ·±åº¦ä¼˜å…ˆæœç´¢éå†å¼•ç”¨æ ‘ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰ç¯å½¢å¼•ç”¨äº†ã€‚

FBRetainCycleDetector çš„æ£€æµ‹æ–¹æ¡ˆæ˜æ˜¾æ›´å¤æ‚ã€æ›´è€—æ—¶ï¼Œæ‰€ä»¥å‡ ä¹ä¸å¯èƒ½é’ˆå¯¹æ‰€æœ‰å¯¹è±¡éƒ½è¿›è¡Œæ£€æµ‹ï¼Œæ‰€ä»¥æ›´å¥½çš„æ–¹æ¡ˆæ˜¯é…åˆ MLeaksFinder æˆ–è€… facebook è‡ªå·±çš„ [FBAllocationTracker](https://github.com/facebookarchive/FBAllocationTracker "FBAllocationTracker")ï¼Œå…ˆæ‰¾åˆ°æ½œåœ¨æ³„éœ²å¯¹è±¡ï¼Œç„¶ååˆ†æè¿™äº›å¯¹è±¡çš„å¼ºå¼•ç”¨å…³ç³»ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ã€‚

**å…¶ä»–æ–¹æ¡ˆ**

åœ¨èµ„æ–™æŸ¥æ‰¾è¿‡ç¨‹ä¸­è¿˜å‘ç°äº†å¦ä¸€ä¸ªåº“ [BlockStrongReferenceObject](https://github.com/tripleCC/Laboratory/tree/master/BlockStrongReferenceObject ""BlockStrongReferenceObject) ï¼Œå®ƒåªæ£€æµ‹ Block å¯¼è‡´çš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œè·Ÿ FBRetainCycleDetector ç±»ä¼¼ï¼Œä¹Ÿæ˜¯è¦åˆ†æ block å†…å­˜å¸ƒå±€ã€‚ä½†ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥å®Œå…¨æ ¹æ®å†…å­˜å¸ƒå±€ï¼Œæ¥å®šä½åˆ°å¼ºå¼•ç”¨å¯¹è±¡ï¼Œä¸»è¦æ˜¯ä¾æ® block å’Œ clang æºç è¿›è¡Œåˆ†æå¾—å‡ºï¼Œè¿™é‡ŒçœŸçš„éå¸¸å¼ºğŸ‘ğŸ»ï¼Œå¦‚æœå¯¹å®ç°ç»†èŠ‚æ„Ÿå…´è¶£å¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼š[èŠèŠå¾ªç¯å¼•ç”¨çš„æ£€æµ‹](https://triplecc.github.io/2019/08/15/%E8%81%8A%E8%81%8A%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E7%9A%84%E6%A3%80%E6%B5%8B/ "èŠèŠå¾ªç¯å¼•ç”¨çš„æ£€æµ‹")ã€‚

å‚è€ƒï¼š

[æ£€æµ‹å’Œè¯Šæ–­ App å†…å­˜é—®é¢˜](https://mp.weixin.qq.com/s/E80VEIJma66fj7BZy1cCeQ)

[dravenessçš„æºç åˆ†æ - FBRetainCycleDetector](https://github.com/draveness/analyze/tree/master/contents/FBRetainCycleDetector "dravenessçš„æºç åˆ†æ - FBRetainCycleDetector")

## ä¼˜ç§€åšå®¢

æ•´ç†ç¼–è¾‘ï¼š[çš®æ‹‰å¤«å¤§ç‹åœ¨æ­¤](https://juejin.cn/user/281104094332653)

1ã€[å¤§ç™½å¥åº·ç³»ç»Ÿ--iOS APPè¿è¡Œæ—¶Crashè‡ªåŠ¨ä¿®å¤ç³»ç»Ÿ](https://neyoufan.github.io/2017/01/13/ios/BayMax_HTSafetyGuard/)

[@çš®æ‹‰å¤«å¤§ç‹](https://juejin.cn/user/281104094332653)ï¼šæ•´ä¸ªæ–‡ç« æ˜¯éå¸¸ç»å…¸çš„ï¼Œä½œè€…ä»‹ç»é€šè¿‡method swizzlingæ›¿æ¢NSObjectçš„allocWithZoneæ–¹æ³•å’Œdeallocæ–¹æ³•å®ç°é‡æŒ‡é’ˆæ‹¦æˆªã€‚

2ã€[JJException](https://github.com/jezzmemo/JJException)

[@çš®æ‹‰å¤«å¤§ç‹](https://juejin.cn/user/281104094332653)ï¼šè¿™ä¸ªåº“éœ€è¦è‡ªå·±æŒ‡å®šæ¢æµ‹å“ªäº›ç±»å¯¹åº”çš„é‡æŒ‡é’ˆã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯æˆ‘ä»¬è‡ªå·±æŒ‡å®š10ä¸ªç±»ï¼Œé‚£ä¹ˆè¿™10ä¸ªç±»çš„å¯¹è±¡å‘ç”Ÿé‡æŒ‡é’ˆæ—¶æˆ‘ä»¬æ‰èƒ½å‘ç°ã€‚å¦‚æœåœ¨æ­¤ä¹‹å¤–ï¼Œé‡æŒ‡é’ˆç›‘æ§ä¸åˆ°ã€‚

3ã€[iOS é‡æŒ‡é’ˆå®šä½:é‡æŒ‡é’ˆå—…æ¢å™¨](https://www.jianshu.com/p/9fd4dc046046)
[@çš®æ‹‰å¤«å¤§ç‹](https://juejin.cn/user/281104094332653)ï¼šæ–‡ç« ä»‹ç»äº†2ä¸ªæ–¹æ¡ˆï¼šï¼ˆ1ï¼‰åœ¨å¼€å‘é˜¶æ®µç ´åå†…å­˜ï¼Œä½¿é‡æŒ‡é’ˆå¿…ç°å´©æºƒ(é‡æŒ‡é’ˆå¯èƒ½ç”±äºå†…å­˜é‡Šæ”¾ä½†æœªè¢«å†™å…¥å¯¼è‡´å´©æºƒä¸å¿…ç°)ã€‚åœ¨freeæ—¶ï¼Œå¹¶ä¸é‡Šæ”¾å†…å­˜ï¼Œä¿ç•™å†…å­˜ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºobjcå¯¹è±¡ï¼Œå¦‚æœæ˜¯objcå¯¹è±¡åˆ™å°†å¯¹è±¡setclassä¸ºè‡ªå®šä¹‰ç±»ï¼Œå€ŸåŠ©æ¶ˆæ¯è½¬å‘å¾—åˆ°å †æ ˆå’Œç±»ä¿¡æ¯ã€‚ç›‘å¬ç³»ç»Ÿå†…å­˜è­¦å‘Šï¼Œæ”¶åˆ°è­¦å‘Šåé‡Šæ”¾ã€‚ï¼ˆ2ï¼‰hook objcçš„dealloc æ–¹æ³•ï¼Œåœ¨deallocæ—¶åˆ¤æ–­æ˜¯å¦éœ€è¦å¼€å¯é‡æŒ‡é’ˆæ¢æµ‹ï¼Œå¦‚æœä¸éœ€è¦åˆ™ç›´æ¥é‡Šæ”¾ï¼Œå¦åˆ™å°†å¯¹è±¡ä¿®æ”¹isaåä¿ç•™å¹¶åŠ å…¥åˆ°å†…å­˜æ± ä¸­ï¼Œå†æ¬¡è°ƒç”¨å¯¹è±¡æ—¶ä¼šè§¦å‘æ¶ˆæ¯è½¬å‘æ‹¦æˆªåˆ°å †æ ˆåŠå¯¹è±¡ç±»åä¿¡æ¯ã€‚

4ã€[iOSé‡æŒ‡é’ˆå®šä½æ€»ç»“](https://juejin.cn/post/6844903747538141191)

[@çš®æ‹‰å¤«å¤§ç‹](https://juejin.cn/user/281104094332653)ï¼šæ–‡ç« ä»‹ç»æ–¹æ¡ˆå¦‚ä¸‹ï¼šåˆ†ç±»è¦†ç›–deallocå‡½æ•°ï¼Œå¹¶åœ¨dealloc ä¸­é‡æ–°è®¾ç½®isaå¹¶ä¸é‡Šæ”¾objï¼Œå…¶ä¸­é‡æ–°æŒ‡å‘çš„isaæ˜¯åŠ¨æ€åˆ›å»ºçš„ã€‚ä¹Ÿå°±æ˜¯è¯´deallocæ˜¯10000ä¸ªç±»ï¼Œä¹Ÿä¼šåŒæ­¥åŠ¨æ€åˆ›å»º10000ä¸ªç±»ã€‚

5ã€[æµ…è°ˆ iOS ä¸­çš„ Crash æ•è·ä¸é˜²æŠ¤](http://shevakuilin.com/ios-crashprotection/)

[@çš®æ‹‰å¤«å¤§ç‹](https://juejin.cn/user/281104094332653)ï¼šæ¨èé˜…è¯»çš„æ–‡ç« ï¼Œæ–‡ç« ä¸ä»…ä»…ä»‹ç»äº†é‡æŒ‡é’ˆç›¸å…³å†…å®¹ï¼Œè¿˜ä»‹ç»äº†å´©æºƒç›¸å…³çš„åŸºç¡€çŸ¥è¯†ã€‚

6ã€[xiejunyi'Blog](https://junyixie.github.io/categories/APM/)

[@çš®æ‹‰å¤«å¤§ç‹](https://juejin.cn/user/281104094332653)ï¼šå¦ç™½è®²æˆ‘å¹¶æ²¡æœ‰çœ‹å®Œçš„æ–‡ç« ï¼Œåœ¨åšæŠ€æœ¯è°ƒç ”æ—¶å‘ç°çš„åšå®¢ï¼Œæ–‡ç« å†…å®¹æ¯”è¾ƒæ·±å…¥å¹¶ä¸”èƒ½çœ‹å‡ºä½œè€…æ˜¯æœ‰å¤§é‡å®æˆ˜ç»éªŒçš„å¼€å‘è€…ï¼Œå› æ­¤æ¨èç»™å¤§å®¶ã€‚


## å­¦ä¹ èµ„æ–™

æ•´ç†ç¼–è¾‘ï¼š[Mimosa](https://juejin.cn/user/1433418892590136)

### Visual Web Skills

åœ°å€ï¼šhttps://andreasbm.github.io/web-skills/

è¿™æ˜¯ä¸€ä»½å¯è§†åŒ–çš„ Web æŠ€èƒ½åˆ—è¡¨ï¼Œå®ƒå¯¹åˆšå¼€å§‹å­¦ä¹  Web æˆ–å·²ç»å·¥ä½œå¤šå¹´å¹¶æƒ³å­¦ä¹ æ–°ä¸œè¥¿çš„äººéƒ½å¾ˆæœ‰ç”¨ï¼Œä½ å¯ä»¥ä»ä¸­äº†è§£ Web å¼€å‘çš„å¤§æ¦‚è·¯å¾„å’Œå›¾è°±ï¼ŒæŒ‰é¡ºåºæˆ–è€…é€‰æ‹©è‡ªå·±æ„Ÿå…´è¶£çš„éƒ¨åˆ†æ¥çœ‹ã€‚é™¤æ­¤ä¹‹å¤–æœ€å¸å¼•äººçš„æ˜¯è¿™ä¸ªåˆ—è¡¨å¯è§†åŒ–çš„éå¸¸æ£’ï¼Œæ¯ä¸ªå›¾æ ‡ç¬¦å·éƒ½å¾ˆå¤§æ–¹ç¾è§‚å½¢è±¡ï¼Œå¿«æ¥çœ‹ä¸€ä¸‹ï¼

![](https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/Web%20Skills.png)

## å·¥å…·æ¨è

æ•´ç†ç¼–è¾‘ï¼š[CoderStar](https://mp.weixin.qq.com/mp/homepage?__biz=MzU4NjQ5NDYxNg==&hid=1&sn=659c56a4ceebb37b1824979522adbb15&scene=18)

### SwiftInfo

**åœ°å€**ï¼šhttps://github.com/rockbruno/SwiftInfo

**è½¯ä»¶çŠ¶æ€**ï¼šå¼€æºã€å…è´¹

**è½¯ä»¶ä»‹ç»**ï¼š

`SwiftInfo` æ˜¯ä¸€ä¸ª `CLI` å·¥å…·ï¼Œç”¨äºæå–ã€è·Ÿè¸ªå’Œåˆ†æå¯¹ `Swift` åº”ç”¨ç¨‹åºæœ‰ç”¨çš„æŒ‡æ ‡ã€‚é™¤äº†è¯¥å·¥å…·é™„å¸¦çš„é»˜è®¤è·Ÿè¸ªé€‰é¡¹å¤–ï¼Œè¿˜æ”¯æŒè‡ªå®šä¹‰ç¼–å†™`.Swift`è„šæœ¬æ¥å®ç°é¢å¤–çš„åŠŸèƒ½ã€‚

é»˜è®¤æ”¯æŒçš„å·¥å…·åŒ…æ‹¬ï¼š

- IPASizeProvider
- WarningCountProvider
- LinesOfCodeProvider
- ...

æ›´å¤šç»†èŠ‚è¯·ç›´æ¥å‰å¾€ repo homepage æŸ¥çœ‹ã€‚

![SwiftInfo](https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/20220112183759.png)

## å…³äºæˆ‘ä»¬

iOS æ‘¸é±¼å‘¨æŠ¥ï¼Œä¸»è¦åˆ†äº«å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„ç»éªŒæ•™è®­ã€ä¼˜è´¨çš„åšå®¢ã€é«˜è´¨é‡çš„å­¦ä¹ èµ„æ–™ã€å®ç”¨çš„å¼€å‘å·¥å…·ç­‰ã€‚å‘¨æŠ¥ä»“åº“åœ¨è¿™é‡Œï¼šhttps://github.com/zhangferry/iOSWeeklyLearning ï¼Œå¦‚æœä½ æœ‰å¥½çš„çš„å†…å®¹æ¨èå¯ä»¥é€šè¿‡ issue çš„æ–¹å¼è¿›è¡Œæäº¤ã€‚å¦å¤–ä¹Ÿå¯ä»¥ç”³è¯·æˆä¸ºæˆ‘ä»¬çš„å¸¸é©»ç¼–è¾‘ï¼Œä¸€èµ·ç»´æŠ¤è¿™ä»½å‘¨æŠ¥ã€‚å¦å¯å…³æ³¨å…¬ä¼—å·ï¼šiOS æˆé•¿ä¹‹è·¯ï¼Œåå°ç‚¹å‡»è¿›ç¾¤äº¤æµï¼Œè”ç³»æˆ‘ä»¬ï¼Œè·å–æ›´å¤šå†…å®¹ã€‚

### å¾€æœŸæ¨è

[iOSæ‘¸é±¼å‘¨æŠ¥ ç¬¬åä¸ƒæœŸ](https://mp.weixin.qq.com/s/3vukUOskJzoPyES2R7rJNg)

[iOSæ‘¸é±¼å‘¨æŠ¥ ç¬¬åå…­æœŸ](https://mp.weixin.qq.com/s/nuij8iKsARAF2rLwkVtA8w)

[iOSæ‘¸é±¼å‘¨æŠ¥ ç¬¬åäº”æœŸ](https://mp.weixin.qq.com/s/6thW_YKforUy_EMkX0OVxA)

[iOSæ‘¸é±¼å‘¨æŠ¥ ç¬¬åå››æœŸ](https://mp.weixin.qq.com/s/br4DUrrtj9-VF-VXnTIcZw)

![](https://gitee.com/zhangferry/Images/raw/master/iOSWeeklyLearning/WechatIMG384.jpeg)
